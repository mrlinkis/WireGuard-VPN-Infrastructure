#!/bin/bash
set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

if [ $# -eq 0 ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_–∞—Ä—Ö–∏–≤—É.tar.gz>"
  echo "–ü—Ä–∏–º–µ—Ä: ./restore.sh emergency-exit-full-backup-20251019.tar.gz"
  exit 1
fi

ARCHIVE="$1"

if [ ! -f "$ARCHIVE" ]; then
  echo "–û—à–∏–±–∫–∞: –∞—Ä—Ö–∏–≤ '$ARCHIVE' –Ω–µ –Ω–∞–π–¥–µ–Ω."
  exit 1
fi

echo "üöÄ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ '–ó–∞–ø–∞—Å–Ω–æ–≥–æ –í—ã—Ö–æ–¥–∞' –∏–∑ $ARCHIVE..."

# –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
TMP_DIR="/tmp/emergency-exit-restore-$$"
mkdir -p "$TMP_DIR"

# –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
tar -xzf "$ARCHIVE" -C "$TMP_DIR"

# –ù–∞—Ö–æ–¥–∏–º –ø–∞–ø–∫—É –≤–Ω—É—Ç—Ä–∏ (–æ–±—ã—á–Ω–æ full-snapshot-YYYYMMDD)
SRC_DIR=$(find "$TMP_DIR" -type d -name "full-snapshot-*" | head -n1)

if [ -z "$SRC_DIR" ]; then
  echo "–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ full-snapshot-* –≤ –∞—Ä—Ö–∏–≤–µ."
  exit 1
fi

# –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—ë –≤ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cp -r "$SRC_DIR"/* .

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ (–Ω–∞ –≤—Å—è–∫–∏–π)
chown -R root:root wg-data/
chmod +x backup-wg-daily.sh backup-wg-weekly.sh

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)
docker-compose down 2>/dev/null || true

# –ó–∞–ø—É—Å–∫–∞–µ–º
docker-compose up -d

echo "‚úÖ WireGuard –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–µ–±-–ø–∞–Ω–µ–ª—å: http://$(hostname -I | awk '{print $1}'):51821"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –±–æ—Ç
if [ -f bot.py ]; then
  echo "ü§ñ –ë–æ—Ç –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ systemd."
fi

echo "üí° –ù–µ –∑–∞–±—É–¥—å—Ç–µ:"
echo "  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Ä—Ç—ã 51820/udp –∏ 51821/tcp –æ—Ç–∫—Ä—ã—Ç—ã"
echo "  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å systemd-—Å–µ—Ä–≤–∏—Å –¥–ª—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –±—ã–ª)"
echo "  - –ó–∞–ø—É—Å—Ç–∏—Ç—å ./backup-wg-daily.sh –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –±—ç–∫–∞–ø–∞"

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -rf "$TMP_DIR"

echo "üî• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."